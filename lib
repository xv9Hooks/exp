-- UniversalUI_Fluent.lua
-- Fluent-style professional single-file Roblox UI Library
-- OOP-ish API: Library:CreateWindow({Title="...", Name="..."}) -> returns windowAPI, screenGui

local Library = {}
local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local LocalPlayer = Players.LocalPlayer

local function safeParent(gui)
    pcall(function() gui.Parent = game:GetService("CoreGui") end)
    if not gui.Parent then
        gui.Parent = LocalPlayer:WaitForChild("PlayerGui")
    end
end

local function new(class) return Instance.new(class) end

local function setProps(inst, props)
    for k,v in pairs(props or {}) do
        pcall(function() inst[k] = v end)
    end
    return inst
end

local function round(frame, radius)
    local c = new("UICorner")
    c.CornerRadius = UDim.new(0, radius or 8)
    c.Parent = frame
    return c
end

local function tween(inst, props, time)
    local info = TweenInfo.new(time or 0.18, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)
    local t = TweenService:Create(inst, info, props)
    t:Play()
    return t
end

local function makeLabel(text, size, align)
    local lbl = new("TextLabel")
    setProps(lbl, {
        Size = size or UDim2.new(1,0,0,24),
        BackgroundTransparency = 1,
        Text = text or "",
        TextColor3 = Color3.fromRGB(22,22,22),
        Font = Enum.Font.SourceSansSemibold,
        TextSize = 14,
        TextXAlignment = align or Enum.TextXAlignment.Left
    })
    return lbl
end

local function createBaseWindow(opts)
    opts = opts or {}
    local screenGui = new("ScreenGui")
    screenGui.Name = opts.Name or "FluentUI"
    screenGui.ResetOnSpawn = false
    safeParent(screenGui)

    local root = new("Frame")
    setProps(root, {
        Size = UDim2.new(0, 420, 0, 320),
        Position = UDim2.new(0.5, -210, 0.5, -160),
        BackgroundColor3 = Color3.fromRGB(250,250,250),
        BorderSizePixel = 0
    })
    round(root, 12)
    root.Parent = screenGui

    local header = new("Frame")
    setProps(header, {
        Size = UDim2.new(1,0,0,48),
        Position = UDim2.new(0,0,0,0),
        BackgroundColor3 = Color3.fromRGB(245,245,245),
        BorderSizePixel = 0
    })
    round(header, 12)
    header.Parent = root

    local title = makeLabel(opts.Title or "Fluent UI", UDim2.new(1,-100,0,48), Enum.TextXAlignment.Left)
    title.Position = UDim2.new(0,20,0,0)
    title.TextColor3 = Color3.fromRGB(18,18,18)
    title.Font = Enum.Font.GothamSemibold
    title.TextSize = 18
    title.Parent = header

    local controls = new("Frame")
    setProps(controls, {
        Size = UDim2.new(0,92,0,48),
        Position = UDim2.new(1,-92,0,0),
        BackgroundTransparency = 1,
    })
    controls.Parent = header

    local closeBtn = new("ImageButton")
    setProps(closeBtn, {
        Size = UDim2.new(0,36,0,36),
        Position = UDim2.new(0.5, -18,0.5,-18),
        BackgroundColor3 = Color3.fromRGB(240,240,240),
        Image = ""
    })
    round(closeBtn, 8)
    closeBtn.Parent = controls

    local closeX = makeLabel("âœ•", UDim2.new(1,0,1,0), Enum.TextXAlignment.Center)
    closeX.TextColor3 = Color3.fromRGB(120,120,120)
    closeX.Font = Enum.Font.Gotham
    closeX.TextSize = 18
    closeX.Parent = closeBtn

    local tabBar = new("Frame")
    setProps(tabBar, {
        Size = UDim2.new(1,0,0,42),
        Position = UDim2.new(0,0,0,48),
        BackgroundTransparency = 1
    })
    tabBar.Parent = root

    local content = new("Frame")
    setProps(content, {
        Size = UDim2.new(1,0,1,-90),
        Position = UDim2.new(0,0,0,90),
        BackgroundTransparency = 1
    })
    content.Parent = root

    local tabs = {}
    local pages = {}
    local selected = nil

    local function createTabButton(name, idx)
        local btn = new("TextButton")
        setProps(btn, {
            Size = UDim2.new(0,110,0,32),
            Position = UDim2.new(0, (idx-1)*116, 0, 6),
            BackgroundColor3 = Color3.fromRGB(250,250,250),
            Text = name,
            Font = Enum.Font.GothamSemibold,
            TextSize = 14,
            TextColor3 = Color3.fromRGB(110,110,110),
            BorderSizePixel = 0
        })
        round(btn, 8)
        btn.Parent = tabBar
        return btn
    end

    local function selectTab(idx)
        for i,v in pairs(pages) do
            v.Visible = (i==idx)
        end
        selected = idx
        for i,b in pairs(tabs) do
            if i==idx then
                tween(b, {TextColor3 = Color3.fromRGB(36,36,36)}, 0.18)
                b.BackgroundColor3 = Color3.fromRGB(245,245,245)
            else
                tween(b, {TextColor3 = Color3.fromRGB(110,110,110)}, 0.18)
                b.BackgroundColor3 = Color3.fromRGB(250,250,250)
            end
        end
    end

    local windowAPI = {}

    function windowAPI:CreateTab(name)
        local idx = #pages + 1
        local btn = createTabButton(name, idx)
        tabs[idx] = btn

        local page = new("ScrollingFrame")
        setProps(page, {
            Size = UDim2.new(1, -20, 1, 0),
            Position = UDim2.new(0,10,0,0),
            CanvasSize = UDim2.new(0,0),
            ScrollBarThickness = 6,
            BackgroundTransparency = 1,
            Visible = false
        })
        page.Parent = content

        local layout = new("UIListLayout")
        layout.Padding = UDim.new(0,10)
        layout.Parent = page
        local padding = new("UIPadding")
        padding.PaddingLeft = UDim.new(0,8)
        padding.PaddingRight = UDim.new(0,8)
        padding.PaddingTop = UDim.new(0,8)
        padding.Parent = page

        pages[idx] = page

        btn.MouseButton1Click:Connect(function() selectTab(idx) end)
        if idx==1 then selectTab(1) end

        local tabAPI = {}

        function tabAPI:CreateSection(name)
            local section = new("Frame")
            setProps(section, {
                Size = UDim2.new(1,0,0,140),
                BackgroundColor3 = Color3.fromRGB(247,247,247),
                BorderSizePixel = 0
            })
            round(section, 10)
            section.Parent = page

            local title = makeLabel(name, UDim2.new(1,0,0,28))
            title.TextColor3 = Color3.fromRGB(36,36,36)
            title.Font = Enum.Font.GothamSemibold
            title.TextSize = 15
            title.Position = UDim2.new(0,12,0,8)
            title.Parent = section

            local container = new("Frame")
            setProps(container, {
                Size = UDim2.new(1,-24,1,-44),
                Position = UDim2.new(0,12,0,36),
                BackgroundTransparency = 1
            })
            container.Parent = section

            local layout = new("UIListLayout")
            layout.Padding = UDim.new(0,8)
            layout.Parent = container

            local sectionAPI = {}

            function sectionAPI:CreateButton(text, callback)
                local btn = new("TextButton")
                setProps(btn, {
                    Size = UDim2.new(1,0,0,36),
                    BackgroundColor3 = Color3.fromRGB(255,255,255),
                    Text = text,
                    Font = Enum.Font.GothamBold,
                    TextSize = 14,
                    TextColor3 = Color3.fromRGB(36,36,36),
                    BorderSizePixel = 0
                })
                round(btn, 8)
                btn.Parent = container
                btn.MouseButton1Click:Connect(function() pcall(callback) end)
                return btn
            end

            function sectionAPI:CreateToggle(text, callback, default)
                local state = default == true
                local holder = new("Frame")
                setProps(holder, {Size = UDim2.new(1,0,0,36), BackgroundTransparency = 1})
                holder.Parent = container

                local lbl = makeLabel(text, UDim2.new(0.7,0,1,0))
                lbl.TextColor3 = Color3.fromRGB(36,36,36)
                lbl.Font = Enum.Font.Gotham
                lbl.Parent = holder

                local btn = new("TextButton")
                setProps(btn, {
                    Size = UDim2.new(0.28,0,0,28),
                    Position = UDim2.new(0.72,0,0,4),
                    BackgroundColor3 = state and Color3.fromRGB(94, 204, 140) or Color3.fromRGB(225,225,225),
                    Text = state and "ON" or "OFF",
                    Font = Enum.Font.GothamBold,
                    TextSize = 13,
                    TextColor3 = Color3.fromRGB(255,255,255),
                    BorderSizePixel = 0
                })
                round(btn, 8)
                btn.Parent = holder

                btn.MouseButton1Click:Connect(function()
                    state = not state
                    btn.BackgroundColor3 = state and Color3.fromRGB(94, 204, 140) or Color3.fromRGB(225,225,225)
                    btn.Text = state and "ON" or "OFF"
                    pcall(callback, state)
                end)

                return holder
            end

            function sectionAPI:CreateSlider(text, min, max, default, callback)
                local value = default or min or 0
                local holder = new("Frame")
                setProps(holder, {Size = UDim2.new(1,0,0,56), BackgroundTransparency = 1})
                holder.Parent = container

                local lbl = makeLabel(text.." ("..tostring(value)..")", UDim2.new(1,0,0,18))
                lbl.TextColor3 = Color3.fromRGB(36,36,36)
                lbl.Parent = holder

                local barBg = new("Frame")
                setProps(barBg, {
                    Size = UDim2.new(1,0,0,12),
                    Position = UDim2.new(0,0,0,26),
                    BackgroundColor3 = Color3.fromRGB(235,235,235),
                    BorderSizePixel = 0
                })
                round(barBg, 8)
                barBg.Parent = holder

                local fill = new("Frame")
                setProps(fill, {
                    Size = UDim2.new( (value-min)/(max-min), 0, 1, 0),
                    BackgroundColor3 = Color3.fromRGB(94, 150, 255),
                    BorderSizePixel = 0,
                    Position = UDim2.new(0,0,0,0)
                })
                round(fill, 8)
                fill.Parent = barBg

                local dragging = false
                local function update(x)
                    local absX = x - barBg.AbsolutePosition.X
                    local rel = math.clamp(absX / barBg.AbsoluteSize.X, 0, 1)
                    fill.Size = UDim2.new(rel,0,1,0)
                    value = math.floor((min + (max-min)*rel)*100)/100
                    lbl.Text = text.." ("..tostring(value)..")"
                    pcall(callback, value)
                end

                barBg.InputBegan:Connect(function(inp)
                    if inp.UserInputType == Enum.UserInputType.MouseButton1 or inp.UserInputType==Enum.UserInputType.Touch then
                        dragging = true
                        update(inp.Position.X)
                    end
                end)
                barBg.InputChanged:Connect(function(inp)
                    if dragging and (inp.UserInputType==Enum.UserInputType.MouseMovement or inp.UserInputType==Enum.UserInputType.Touch) then
                        update(inp.Position.X)
                    end
                end)
                UserInputService.InputEnded:Connect(function(inp)
                    if inp.UserInputType==Enum.UserInputType.MouseButton1 or inp.UserInputType==Enum.UserInputType.Touch then
                        dragging = false
                    end
                end)

                return holder
            end

            function sectionAPI:CreateDropdown(text, options, callback)
                local holder = new("Frame")
                setProps(holder, {Size = UDim2.new(1,0,0,36), BackgroundTransparency = 1})
                holder.Parent = container

                local lbl = makeLabel(text, UDim2.new(0.6,0,1,0))
                lbl.TextColor3 = Color3.fromRGB(36,36,36)
                lbl.Parent = holder

                local sel = new("TextButton")
                setProps(sel, {
                    Size = UDim2.new(0.38,0,0,28),
                    Position = UDim2.new(0.62,0,0,4),
                    BackgroundColor3 = Color3.fromRGB(255,255,255),
                    Text = tostring(options[1] or "Select"),
                    Font = Enum.Font.Gotham,
                    TextSize = 13,
                    TextColor3 = Color3.fromRGB(36,36,36),
                    BorderSizePixel = 0
                })
                round(sel, 8)
                sel.Parent = holder

                local list = new("Frame")
                setProps(list, {Size = UDim2.new(0, sel.AbsoluteSize.X,0,0), Position = UDim2.new(0.62,0,0,42), BackgroundColor3 = Color3.fromRGB(255,255,255), BorderSizePixel = 0, Visible = false})
                round(list, 8)
                list.Parent = holder

                local layout = new("UIListLayout")
                layout.Parent = list

                local function openList()
                    list.Visible = not list.Visible
                    if list.Visible then
                        local h = #options * 32
                        list.Size = UDim2.new(0, sel.AbsoluteSize.X, 0, h)
                    else
                        list.Size = UDim2.new(0, sel.AbsoluteSize.X, 0, 0)
                    end
                end

                sel.MouseButton1Click:Connect(openList)

                for i,opt in ipairs(options) do
                    local it = new("TextButton")
                    setProps(it, {Size = UDim2.new(1,0,0,32), Text = opt, Font = Enum.Font.Gotham, TextSize = 13, TextColor3 = Color3.fromRGB(36,36,36), BackgroundTransparency = 1, BorderSizePixel = 0})
                    it.Parent = list
                    it.MouseButton1Click:Connect(function()
                        sel.Text = opt
                        list.Visible = false
                        pcall(callback, opt)
                    end)
                end

                return holder
            end

            function sectionAPI:CreateKeybind(text, callback)
                local holder = new("Frame")
                setProps(holder, {Size=UDim2.new(1,0,0,36), BackgroundTransparency = 1})
                holder.Parent = container

                local lbl = makeLabel(text, UDim2.new(0.6,0,1,0))
                lbl.Parent = holder

                local btn = new("TextButton")
                setProps(btn, {Size=UDim2.new(0.38,0,0,28), Position = UDim2.new(0.62,0,0,4), Text = "...", Font = Enum.Font.Gotham, TextSize = 13, TextColor3 = Color3.fromRGB(36,36,36), BackgroundColor3 = Color3.fromRGB(255,255,255), BorderSizePixel = 0})
                round(btn, 8)
                btn.Parent = holder

                local listening = false
                btn.MouseButton1Click:Connect(function()
                    listening = true
                    btn.Text = "Press"
                    local conn
                    conn = UserInputService.InputBegan:Connect(function(input, gp)
                        if not gp and input.UserInputType == Enum.UserInputType.Keyboard then
                            btn.Text = input.KeyCode.Name
                            pcall(callback, input.KeyCode)
                            listening = false
                            conn:Disconnect()
                        end
                    end)
                end)

                return holder
            end

            function sectionAPI:CreateTextbox(placeholder, callback)
                local holder = new("Frame")
                setProps(holder, {Size=UDim2.new(1,0,0,40), BackgroundTransparency = 1})
                holder.Parent = container

                local box = new("TextBox")
                setProps(box, {Size = UDim2.new(1,0,0,36), Text = "", PlaceholderText = placeholder or "", Font = Enum.Font.Gotham, TextSize = 14, TextColor3 = Color3.fromRGB(36,36,36), BackgroundColor3 = Color3.fromRGB(255,255,255), BorderSizePixel = 0})
                round(box, 8)
                box.Parent = holder

                box.FocusLost:Connect(function(enter)
                    if enter then pcall(callback, box.Text) end
                end)

                return holder
            end

            function sectionAPI:CreateColorPicker(text, callback, default)
                local holder = new("Frame")
                setProps(holder, {Size=UDim2.new(1,0,0,56), BackgroundTransparency = 1})
                holder.Parent = container

                local lbl = makeLabel(text, UDim2.new(0.6,0,0,18))
                lbl.Parent = holder

                local preview = new("TextButton")
                setProps(preview, {Size = UDim2.new(0.28,0,0,28), Position = UDim2.new(0.62,0,0,6), BackgroundColor3 = default or Color3.fromRGB(94,150,255), BorderSizePixel = 0})
                round(preview, 8)
                preview.Parent = holder

                local picker = new("Frame")
                setProps(picker, {Size = UDim2.new(0,220,0,140), Position = UDim2.new(0,0,0,60), BackgroundColor3 = Color3.fromRGB(255,255,255), BorderSizePixel = 0, Visible = false})
                round(picker, 10)
                picker.Parent = holder

                local sat = new("ImageButton")
                setProps(sat, {Size = UDim2.new(0,160,0,120), Position = UDim2.new(0,8,0,8), BackgroundColor3 = Color3.fromRGB(255,255,255), AutoButtonColor = false})
                sat.Parent = picker

                local hue = new("Frame")
                setProps(hue, {Size = UDim2.new(0,36,0,120), Position = UDim2.new(0,174,0,8), BackgroundColor3 = Color3.fromRGB(255,255,255)})
                round(hue, 6)
                hue.Parent = picker

                local function setColor(c)
                    preview.BackgroundColor3 = c
                    pcall(callback, c)
                end

                preview.MouseButton1Click:Connect(function() picker.Visible = not picker.Visible end)

                local function updateFromPos(x,y)
                    local ux = math.clamp((x - sat.AbsolutePosition.X)/sat.AbsoluteSize.X, 0, 1)
                    local uy = math.clamp((y - sat.AbsolutePosition.Y)/sat.AbsoluteSize.Y, 0, 1)
                    local hueV = 0
                    setColor(Color3.fromHSV(hueV, 1-uy, ux))
                end

                sat.InputBegan:Connect(function(inp)
                    if inp.UserInputType==Enum.UserInputType.MouseButton1 or inp.UserInputType==Enum.UserInputType.Touch then
                        updateFromPos(inp.Position.X, inp.Position.Y)
                    end
                end)
                sat.InputChanged:Connect(function(inp)
                    if inp.UserInputType==Enum.UserInputType.MouseMovement or inp.UserInputType==Enum.UserInputType.Touch then
                        updateFromPos(inp.Position.X, inp.Position.Y)
                    end
                end)

                return holder
            end

            return sectionAPI
        end

        return tabAPI
    end

    -- dragging logic
    local dragging = false
    local dragInput, dragStart, startPos
    local function update(input)
        local delta = input.Position - dragStart
        root.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
    end

    header.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType==Enum.UserInputType.Touch then
            dragging = true
            dragStart = input.Position
            startPos = root.Position
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    dragging = false
                end
            end)
        end
    end)

    header.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType==Enum.UserInputType.Touch then
            dragInput = input
        end
    end)

    UserInputService.InputChanged:Connect(function(input)
        if input == dragInput and dragging then
            update(input)
        end
    end)

    closeBtn.MouseButton1Click:Connect(function()
        pcall(function() screenGui:Destroy() end)
    end)

    -- Notification system
    local notifGui = nil
    local function ensureNotif()
        if notifGui and notifGui.Parent then return notifGui end
        notifGui = new("ScreenGui")
        notifGui.Name = "_Fluent_Notifs"
        notifGui.ResetOnSpawn = false
        safeParent(notifGui)
        local holder = new("Frame")
        setProps(holder, {Size=UDim2.new(0,320,0,0), Position = UDim2.new(1, -340, 0.04, 0), BackgroundTransparency = 1})
        holder.Parent = notifGui
        holder.Name = "Holder"
        return notifGui, holder
    end

    function windowAPI:Notify(title, text, duration)
        duration = duration or 3
        local gui, holder = ensureNotif()
        local card = new("Frame")
        setProps(card, {Size = UDim2.new(0,320,0,0), BackgroundColor3 = Color3.fromRGB(255,255,255), BorderSizePixel = 0})
        round(card, 10)
        card.Parent = holder

        local t1 = makeLabel(title, UDim2.new(1,0,0,28), Enum.TextXAlignment.Left)
        t1.TextColor3 = Color3.fromRGB(36,36,36)
        t1.Font = Enum.Font.GothamBold
        t1.TextSize = 14
        t1.Position = UDim2.new(0,12,0,8)
        t1.Parent = card

        local t2 = makeLabel(text, UDim2.new(1,0,0,40), Enum.TextXAlignment.Left)
        t2.TextColor3 = Color3.fromRGB(76,76,76)
        t2.Font = Enum.Font.Gotham
        t2.TextSize = 13
        t2.Position = UDim2.new(0,12,0,30)
        t2.Parent = card

        tween(card, {Size = UDim2.new(0,320,0,88)}, 0.22)
        delay(duration, function()
            tween(card, {Size = UDim2.new(0,320,0,0)}, 0.18)
            wait(0.18)
            pcall(function() card:Destroy() end)
        end)
    end

    function windowAPI:Destroy()
        pcall(function() screenGui:Destroy() end)
    end

    function windowAPI:SetPosition(pos)
        root.Position = pos
    end

    function windowAPI:GetScreenGui()
        return screenGui
    end

    return windowAPI, screenGui
end

Library.CreateWindow = function(opts) return createBaseWindow(opts) end
return Library
