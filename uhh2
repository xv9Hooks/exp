--[[
    NexusUI SaveManager Addon
    Config kaydetme/yÃ¼kleme sistemi
]]

local SaveManager = {}
SaveManager.__index = SaveManager

local HttpService = game:GetService("HttpService")

SaveManager.Library = nil
SaveManager.Folder = "NexusUI"
SaveManager.IgnoreIndexes = {}
SaveManager.Parser = {
    encode = function(data)
        return HttpService:JSONEncode(data)
    end,
    decode = function(data)
        return HttpService:JSONDecode(data)
    end
}

function SaveManager:SetLibrary(library)
    self.Library = library
end

function SaveManager:SetFolder(folder)
    self.Folder = folder
    
    -- Create folder if using file system
    local success, err = pcall(function()
        if not isfolder(self.Folder) then
            makefolder(self.Folder)
        end
    end)
end

function SaveManager:IgnoreThemeSettings()
    self:SetIgnoreIndexes({"Theme", "InterfaceTheme"})
end

function SaveManager:SetIgnoreIndexes(indexes)
    self.IgnoreIndexes = indexes
end

function SaveManager:GetConfigs()
    local configs = {}
    
    local success, result = pcall(function()
        if isfolder(self.Folder) then
            return listfiles(self.Folder)
        end
        return {}
    end)
    
    if success then
        for _, file in ipairs(result) do
            local name = file:match("([^/\\]+)%.json$")
            if name then
                table.insert(configs, name)
            end
        end
    end
    
    return configs
end

function SaveManager:Save(name)
    if not self.Library then return false, "Library not set" end
    
    local data = {}
    
    for index, option in pairs(self.Library.Options) do
        local shouldIgnore = false
        for _, ignored in ipairs(self.IgnoreIndexes) do
            if index == ignored then
                shouldIgnore = true
                break
            end
        end
        
        if not shouldIgnore then
            if option.Value ~= nil then
                if typeof(option.Value) == "Color3" then
                    data[index] = {
                        type = "Color3",
                        value = {option.Value.R, option.Value.G, option.Value.B}
                    }
                elseif typeof(option.Value) == "table" then
                    data[index] = {
                        type = "table",
                        value = option.Value
                    }
                else
                    data[index] = {
                        type = typeof(option.Value),
                        value = option.Value
                    }
                end
                
                -- Save transparency for colorpickers
                if option.Transparency then
                    data[index].transparency = option.Transparency
                end
            end
        end
    end
    
    local encoded = self.Parser.encode(data)
    
    local success, err = pcall(function()
        writefile(self.Folder .. "/" .. name .. ".json", encoded)
    end)
    
    if success then
        self.Library:Notify({
            Title = "Config Saved",
            Content = "Successfully saved config: " .. name,
            Type = "success",
            Duration = 3
        })
    else
        self.Library:Notify({
            Title = "Save Failed",
            Content = "Failed to save config: " .. tostring(err),
            Type = "error",
            Duration = 5
        })
    end
    
    return success, err
end

function SaveManager:Load(name)
    if not self.Library then return false, "Library not set" end
    
    local success, result = pcall(function()
        return readfile(self.Folder .. "/" .. name .. ".json")
    end)
    
    if not success then
        self.Library:Notify({
            Title = "Load Failed",
            Content = "Config file not found: " .. name,
            Type = "error",
            Duration = 5
        })
        return false, "File not found"
    end
    
    local data = self.Parser.decode(result)
    
    for index, saved in pairs(data) do
        local option = self.Library.Options[index]
        if option then
            if saved.type == "Color3" then
                local color = Color3.new(saved.value[1], saved.value[2], saved.value[3])
                if option.SetValueRGB then
                    option:SetValueRGB(color)
                end
                if saved.transparency and option.Transparency ~= nil then
                    option.Transparency = saved.transparency
                end
            elseif option.SetValue then
                option:SetValue(saved.value)
            end
        end
    end
    
    self.Library:Notify({
        Title = "Config Loaded",
        Content = "Successfully loaded config: " .. name,
        Type = "success",
        Duration = 3
    })
    
    return true
end

function SaveManager:Delete(name)
    local success, err = pcall(function()
        delfile(self.Folder .. "/" .. name .. ".json")
    end)
    
    if success then
        self.Library:Notify({
            Title = "Config Deleted",
            Content = "Successfully deleted config: " .. name,
            Type = "success",
            Duration = 3
        })
    end
    
    return success, err
end

function SaveManager:SetAutoload(name)
    pcall(function()
        writefile(self.Folder .. "/autoload.txt", name)
    end)
end

function SaveManager:GetAutoload()
    local success, result = pcall(function()
        return readfile(self.Folder .. "/autoload.txt")
    end)
    return success and result or nil
end

function SaveManager:LoadAutoloadConfig()
    local autoload = self:GetAutoload()
    if autoload then
        self:Load(autoload)
    end
end

function SaveManager:BuildConfigSection(tab)
    if not self.Library or not tab then return end
    
    tab:AddSection("Configuration")
    
    local configDropdown
    
    local function refreshConfigs()
        local configs = self:GetConfigs()
        if configDropdown then
            configDropdown:Refresh(configs)
        end
        return configs
    end
    
    local configs = refreshConfigs()
    
    configDropdown = tab:AddDropdown("ConfigList", {
        Title = "Config",
        Values = #configs > 0 and configs or {"No configs"},
        Default = 1
    })
    
    tab:AddInput("ConfigName", {
        Title = "Config Name",
        Placeholder = "Enter config name..."
    })
    
    tab:AddButton({
        Title = "Save Config",
        Description = "Save current settings to config",
        Callback = function()
            local name = self.Library.Options["ConfigName"].Value
            if name and name ~= "" then
                self:Save(name)
                refreshConfigs()
            end
        end
    })
    
    tab:AddButton({
        Title = "Load Config",
        Description = "Load selected config",
        Callback = function()
            local selected = self.Library.Options["ConfigList"].Value
            if selected and selected ~= "No configs" then
                self:Load(selected)
            end
        end
    })
    
    tab:AddButton({
        Title = "Delete Config",
        Description = "Delete selected config",
        Callback = function()
            local selected = self.Library.Options["ConfigList"].Value
            if selected and selected ~= "No configs" then
                self:Delete(selected)
                refreshConfigs()
            end
        end
    })
    
    tab:AddButton({
        Title = "Refresh Configs",
        Callback = function()
            refreshConfigs()
        end
    })
    
    tab:AddToggle("AutoloadConfig", {
        Title = "Autoload Config",
        Default = false,
        Callback = function(value)
            if value then
                local selected = self.Library.Options["ConfigList"].Value
                if selected and selected ~= "No configs" then
                    self:SetAutoload(selected)
                end
            end
        end
    })
end

return SaveManager
